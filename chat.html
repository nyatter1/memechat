<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MEME CHAT 9000 // THE VOID</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Comic+Neue:wght@700&family=Press+Start+2P&family=Rubik+Glitch&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Creepster&family=Monoton&family=Orbitron&family=Rye&family=VT323&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>
    <style>
        /* SHARED CHAOS STYLES */
        body {
            font-family: 'Comic Neue', 'Comic Sans MS', sans-serif;
            overflow: hidden; /* Main chat shouldn't scroll body */
            cursor: auto;
        }

        .font-pixel { font-family: 'Press Start 2P', cursive; }
        .font-glitch { font-family: 'Rubik Glitch', system-ui; }

        @keyframes rainbow-bg {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .bg-chaos {
            background: linear-gradient(-45deg, #000000, #1a0b2e, #0f0f29, #001a1a, #26001b, #1a0000, #000000);
            background-size: 400% 400%;
            animation: rainbow-bg 20s ease infinite;
        }

        /* Glitch Text */
        .glitch-text { position: relative; }
        .glitch-text::before, .glitch-text::after {
            content: attr(data-text);
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: #1a1a1a;
        }
        .glitch-text::before {
            left: 2px; text-shadow: -1px 0 #ff00c1;
            clip: rect(44px, 450px, 56px, 0);
            animation: glitch-anim 5s infinite linear alternate-reverse;
        }
        .glitch-text::after {
            left: -2px; text-shadow: -1px 0 #00fff9;
            clip: rect(44px, 450px, 56px, 0);
            animation: glitch-anim2 5s infinite linear alternate-reverse;
        }
        @keyframes glitch-anim {
            0% { clip: rect(10px, 9999px, 30px, 0); }
            20% { clip: rect(80px, 9999px, 100px, 0); }
            100% { clip: rect(90px, 9999px, 50px, 0); }
        }
        @keyframes glitch-anim2 {
            0% { clip: rect(60px, 9999px, 10px, 0); }
            100% { clip: rect(70px, 9999px, 100px, 0); }
        }

        /* Specific Chat Styles */
        .message-bubble {
            padding: 2px 0;
            background: transparent;
            box-shadow: none;
            border: none;
            width: 100%;
        }
        
        .message-container {
            display: flex;
            gap: 12px;
            align-items: flex-start;
            width: 100%;
        }

        .brutal-btn {
            border: 2px solid white;
            box-shadow: 3px 3px 0px #000;
            background: #ff00ff;
            color: white;
            font-family: 'Press Start 2P';
            transition: all 0.1s;
        }
        .brutal-btn:active {
            transform: translate(2px, 2px);
            box-shadow: 1px 1px 0px #000;
        }

        .brutal-shadow {
            box-shadow: 8px 8px 0px 0px #ffffff;
        }
        
        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #000; border-left: 2px solid white; }
        ::-webkit-scrollbar-thumb { background: #ff00c8; border: 2px solid white; }
        ::-webkit-scrollbar-thumb:hover { background: #ffffff; }

        .floating-img {
            position: absolute;
            z-index: 0;
            opacity: 0.1;
            pointer-events: none;
        }
        
        .user-item:hover {
            background-color: #333;
            transform: translateX(-5px);
        }

        /* MODAL ANIMATION */
        #profile-modal:not(.hidden) {
            animation: modal-pop 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        @keyframes modal-pop {
            0% { opacity: 0; transform: scale(0.9) translate(-50%, -50%); }
            100% { opacity: 1; transform: scale(1) translate(-50%, -50%); }
        }
        
        .edit-overlay {
            transition: opacity 0.2s;
        }

        /* NOTIFICATION STYLES */
        .notif-item {
            animation: slideIn 0.2s ease-out;
        }
        @keyframes slideIn {
            from { transform: translateX(20px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* Friend Request Buttons */
        .req-btn {
            font-family: 'Press Start 2P';
            font-size: 8px;
            padding: 4px 6px;
            cursor: pointer;
            border: 1px solid white;
        }
        .req-accept { background: #00aa00; color: white; }
        .req-decline { background: #aa0000; color: white; }

        /* GLOW EFFECT FOR MENTIONS */
        .glow-text {
            color: #fff;
            text-shadow: 0 0 5px #fff, 0 0 10px #ff00de, 0 0 20px #ff00de;
            font-weight: bold;
            animation: pulse-glow 2s infinite;
        }
        @keyframes pulse-glow {
            0% { text-shadow: 0 0 5px #fff, 0 0 10px #ff00de; }
            50% { text-shadow: 0 0 10px #fff, 0 0 20px #00ffff; }
            100% { text-shadow: 0 0 5px #fff, 0 0 10px #ff00de; }
        }
        
        .username-link:hover {
            text-decoration: underline;
            cursor: pointer;
        }

        /* PM WINDOW STYLES */
        .pm-window {
            position: absolute;
            width: 320px;
            height: 400px;
            background: #111;
            border: 4px solid #fff;
            box-shadow: 8px 8px 0 #ff00ff;
            display: flex;
            flex-direction: column;
            z-index: 100;
            resize: both;
            overflow: hidden;
            min-width: 250px;
            min-height: 250px;
            top: 100px;
            left: 100px;
        }
        .pm-window.pinned {
            border-color: #ffd700;
            box-shadow: 8px 8px 0 #ffd700;
            z-index: 150 !important;
        }
        .pm-header {
            background: #222;
            padding: 8px;
            cursor: grab;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid #fff;
        }
        .pm-header:active {
            cursor: grabbing;
            background: #444;
        }
        .pm-messages {
            flex-grow: 1;
            overflow-y: auto;
            padding: 10px;
            background: #000;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .pm-input-area {
            border-top: 2px solid #fff;
            padding: 8px;
            background: #111;
            display: flex;
            gap: 4px;
            align-items: center;
        }
        
        /* LIGHTBOX */
        #lightbox {
            background: rgba(0,0,0,0.9);
            backdrop-filter: blur(5px);
            animation: fadeIn 0.2s;
        }
        #lightbox img {
            max-width: 90vw;
            max-height: 90vh;
            border: 4px solid white;
            box-shadow: 0 0 50px rgba(255, 0, 255, 0.5);
        }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* CONTEXT MENU STYLES */
        #context-menu {
            position: fixed;
            background: #000;
            border: 4px solid #fff;
            box-shadow: 6px 6px 0 #00ffff;
            z-index: 200;
            display: none;
            flex-direction: column;
            min-width: 150px;
        }
        #context-menu button {
            padding: 12px;
            text-align: left;
            color: white;
            font-family: 'Press Start 2P', cursive;
            font-size: 10px;
            border-bottom: 2px solid #333;
            transition: background 0.1s;
        }
        #context-menu button:hover {
            background: #ff00c8;
            color: black;
        }
        #context-menu button:last-child {
            border-bottom: none;
        }

        /* INBOX STYLES */
        #inbox-panel {
            box-shadow: -8px 8px 0px 0px #ffffff;
        }
        .inbox-item:hover {
            background: #222;
        }

        /* =========================================
           CUSTOMIZATION SYSTEM CSS (50+ Per Cat)
           ========================================= */

        /* --- BACKGROUND THEMES --- */
        .bg-theme-1 { background-color: #000; }
        .bg-theme-2 { background: repeating-linear-gradient(45deg, #000, #000 10px, #111 10px, #111 20px); }
        .bg-theme-3 { background: radial-gradient(circle, #222, #000); }
        .bg-theme-4 { background: linear-gradient(to bottom, #000044, #000); }
        .bg-theme-5 { background: linear-gradient(to bottom, #440000, #000); }
        .bg-theme-6 { background: linear-gradient(to bottom, #004400, #000); }
        .bg-theme-7 { background: conic-gradient(from 0deg, #111, #333, #111); }
        .bg-theme-8 { background-image: radial-gradient(#333 1px, transparent 1px); background-size: 20px 20px; }
        .bg-theme-9 { background: linear-gradient(135deg, #1a0b2e 25%, transparent 25%) -50px 0, linear-gradient(225deg, #1a0b2e 25%, transparent 25%) -50px 0, linear-gradient(315deg, #1a0b2e 25%, transparent 25%), linear-gradient(45deg, #1a0b2e 25%, transparent 25%); background-size: 100px 100px; background-color: #000; }
        .bg-theme-10 { background: linear-gradient(90deg, #000 50%, #111 50%); background-size: 50px 100%; }
        /* Patterns */
        .bg-theme-11 { background: radial-gradient(circle, transparent 20%, #000 20%, #000 80%, transparent 80%, transparent), radial-gradient(circle, transparent 20%, #000 20%, #000 80%, transparent 80%, transparent) 25px 25px, linear-gradient(#222 2px, transparent 2px) 0 -1px, linear-gradient(90deg, #222 2px, transparent 2px) -1px 0; background-size: 50px 50px, 50px 50px, 25px 25px, 25px 25px; background-color: #111; }
        .bg-theme-12 { background: repeating-linear-gradient(90deg, #111, #111 1px, transparent 1px, transparent 10px); }
        .bg-theme-13 { background: repeating-radial-gradient(circle, #222, #222 5px, #000 5px, #000 10px); }
        .bg-theme-14 { background: linear-gradient(45deg, #ff00ff 25%, transparent 25%, transparent 75%, #ff00ff 75%, #ff00ff), linear-gradient(45deg, #ff00ff 25%, transparent 25%, transparent 75%, #ff00ff 75%, #ff00ff); background-color: #000; background-size: 20px 20px; background-position: 0 0, 10px 10px; opacity: 0.2; }
        .bg-theme-15 { background: linear-gradient(to right, #243949 0%, #517fa4 100%); }
        .bg-theme-16 { background: linear-gradient(to top, #30cfd0 0%, #330867 100%); }
        .bg-theme-17 { background: linear-gradient(to top, #a18cd1 0%, #fbc2eb 100%); }
        .bg-theme-18 { background: linear-gradient(120deg, #84fab0 0%, #8fd3f4 100%); }
        .bg-theme-19 { background: linear-gradient(to right, #fa709a 0%, #fee140 100%); }
        .bg-theme-20 { background: linear-gradient(to top, #09203f 0%, #537895 100%); }
        /* Textures & Neons */
        .bg-theme-21 { background: linear-gradient(45deg, #85FFBD 0%, #FFFB7D 100%); }
        .bg-theme-22 { background: linear-gradient(to bottom, #323232 0%, #3F3F3F 40%, #1C1C1C 150%), linear-gradient(to top, rgba(255,255,255,0.40) 0%, rgba(0,0,0,0.25) 200%); background-blend-mode: multiply; }
        .bg-theme-23 { background: linear-gradient(to bottom, #000000, #434343); }
        .bg-theme-24 { background: linear-gradient(to right, #0f0c29, #302b63, #24243e); }
        .bg-theme-25 { background: linear-gradient(to right, #000000, #53346d); }
        .bg-theme-26 { background: linear-gradient(to bottom, #232526, #414345); }
        .bg-theme-27 { background: linear-gradient(to right, #4b6cb7, #182848); }
        .bg-theme-28 { background: linear-gradient(to right, #5f2c82, #49a09d); }
        .bg-theme-29 { background: linear-gradient(to right, #74ebd5, #ACB6E5); }
        .bg-theme-30 { background: linear-gradient(to right, #f857a6, #ff5858); }
        .bg-theme-31 { background: repeating-linear-gradient(45deg, #606dbc, #606dbc 10px, #465298 10px, #465298 20px); }
        .bg-theme-32 { background: radial-gradient(circle at 50% 50%, #444, #000); }
        .bg-theme-33 { background: linear-gradient(135deg, #000 25%, #111 25%, #111 50%, #000 50%, #000 75%, #111 75%, #111 100%); background-size: 20px 20px; }
        .bg-theme-34 { background: linear-gradient(to bottom, #000 0%, #200 100%); border: 2px solid red; }
        .bg-theme-35 { background: linear-gradient(to bottom, #000 0%, #020 100%); border: 2px solid green; }
        .bg-theme-36 { background: linear-gradient(to bottom, #000 0%, #002 100%); border: 2px solid blue; }
        .bg-theme-37 { background: #000 url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI4IiBoZWlnaHQ9IjgiPgo8cmVjdCB3aWR0aD0iOCIgaGVpZ2h0PSI4IiBmaWxsPSIjMDAwIiAvPgo8cGF0aCBkPSJNMCAwTDggOFpNOCAwTDAgOFoiIHN0cm9rZT0iIzIyMiIgc3Ryb2tlLXdpZHRoPSIxIi8+Cjwvc3ZnPg=='); }
        .bg-theme-38 { background: conic-gradient(#f00, #ff0, #0f0, #0ff, #00f, #f0f, #f0f, #f00); filter: blur(20px) opacity(0.5); }
        .bg-theme-39 { background: #222; box-shadow: inset 0 0 50px #000; }
        .bg-theme-40 { background: linear-gradient(45deg, black, #333); }
        /* Animated */
        @keyframes bg-anim-1 { 0% {background-position: 0% 50%} 50% {background-position: 100% 50%} 100% {background-position: 0% 50%} }
        .bg-theme-41 { background: linear-gradient(270deg, #ff0000, #00ff00, #0000ff); background-size: 600% 600%; animation: bg-anim-1 5s ease infinite; }
        .bg-theme-42 { background: linear-gradient(270deg, #000, #333); background-size: 400% 400%; animation: bg-anim-1 10s ease infinite; }
        .bg-theme-43 { background: linear-gradient(45deg, #12c2e9, #c471ed, #f64f59); background-size: 200% 200%; animation: bg-anim-1 5s infinite; }
        .bg-theme-44 { background: linear-gradient(to right, #2980b9, #6dd5fa, #ffffff); background-size: 200%; animation: bg-anim-1 3s infinite; }
        .bg-theme-45 { background: repeating-linear-gradient(to right, #000, #111 10%, #000 20%); background-size: 200% 100%; animation: bg-anim-1 2s linear infinite; }
        .bg-theme-46 { background: #000; border: 4px dashed white; animation: bg-anim-1 1s infinite; }
        .bg-theme-47 { background: radial-gradient(circle, red, black); background-size: 200% 200%; animation: bg-anim-1 2s infinite; }
        .bg-theme-48 { background: linear-gradient(to bottom, transparent 50%, rgba(0,255,0,0.2) 50%); background-size: 100% 4px; animation: scanline 0.2s linear infinite; }
        @keyframes scanline { 0% {background-position: 0 0;} 100% {background-position: 0 4px;} }
        .bg-theme-49 { background: #000; border: 2px solid white; box-shadow: 0 0 20px #fff; }
        .bg-theme-50 { background: url('https://media.giphy.com/media/U3qYN8S0j3bpK/giphy.gif'); background-size: cover; opacity: 0.8; }

        /* --- USERNAME EFFECTS --- */
        .name-fx-1 { color: #fff; }
        .name-fx-2 { color: #ff00ff; text-shadow: 0 0 5px #ff00ff; }
        .name-fx-3 { color: #00ffff; text-shadow: 0 0 5px #00ffff; }
        .name-fx-4 { color: #00ff00; text-shadow: 0 0 5px #00ff00; }
        .name-fx-5 { color: #ffff00; text-shadow: 0 0 5px #ffff00; }
        .name-fx-6 { color: #ff0000; text-shadow: 0 0 10px #ff0000, 0 0 20px #ff0000; }
        .name-fx-7 { background: linear-gradient(to right, #ff0000, #ffff00); -webkit-background-clip: text; color: transparent; }
        .name-fx-8 { background: linear-gradient(to right, #00ffff, #0000ff); -webkit-background-clip: text; color: transparent; }
        .name-fx-9 { background: linear-gradient(to right, #ff00ff, #00ffff); -webkit-background-clip: text; color: transparent; }
        .name-fx-10 { background: linear-gradient(to right, gold, orange); -webkit-background-clip: text; color: transparent; text-shadow: 0 0 2px gold; }
        .name-fx-11 { background: linear-gradient(to right, silver, white); -webkit-background-clip: text; color: transparent; text-shadow: 0 0 2px silver; }
        .name-fx-12 { color: white; text-shadow: 2px 2px 0 #000, -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000, 1px 1px 0 #000; }
        .name-fx-13 { color: black; -webkit-text-stroke: 1px white; }
        .name-fx-14 { color: black; -webkit-text-stroke: 1px #ff00ff; }
        .name-fx-15 { color: black; -webkit-text-stroke: 1px #00ffff; }
        .name-fx-16 { font-family: 'Rubik Glitch'; color: #ff00ff; }
        .name-fx-17 { font-family: 'Press Start 2P'; color: #00ff00; }
        .name-fx-18 { font-family: 'Creepster', cursive; color: #ff0000; font-size: 1.2em; }
        .name-fx-19 { font-family: 'Monoton', cursive; color: #fff; }
        .name-fx-20 { font-family: 'Orbitron', sans-serif; color: #00ffff; }
        .name-fx-21 { font-family: 'Rye', serif; color: #deb887; }
        .name-fx-22 { font-family: 'VT323', monospace; color: #00ff00; font-size: 1.3em; }
        .name-fx-23 { text-decoration: underline wavy #ff00ff; }
        .name-fx-24 { text-decoration: line-through red; }
        .name-fx-25 { border-bottom: 2px solid white; }
        .name-fx-26 { background: #fff; color: #000; padding: 0 4px; }
        .name-fx-27 { background: #ff00ff; color: #fff; padding: 0 4px; }
        .name-fx-28 { transform: skew(-10deg); display: inline-block; }
        .name-fx-29 { letter-spacing: 2px; }
        .name-fx-30 { letter-spacing: -1px; }
        .name-fx-31 { text-shadow: 3px 3px 0px rgba(0,0,0,0.5); }
        .name-fx-32 { text-shadow: 0 0 5px #fff, 0 0 10px #fff, 0 0 15px #fff; color: transparent; }
        .name-fx-33 { background: linear-gradient(to bottom, #fff 50%, #888 50%); -webkit-background-clip: text; color: transparent; }
        .name-fx-34 { background: repeating-linear-gradient(45deg, red, yellow 10%, red 20%); -webkit-background-clip: text; color: transparent; }
        .name-fx-35 { filter: blur(0.5px); color: #88ff88; }
        .name-fx-36 { text-transform: uppercase; font-weight: 900; }
        .name-fx-37 { text-transform: lowercase; font-style: italic; }
        .name-fx-38 { border: 1px dashed white; padding: 2px; }
        .name-fx-39 { box-shadow: 2px 2px 0 #fff; background: #000; padding: 2px; }
        .name-fx-40 { opacity: 0.7; }
        /* Animated Names */
        @keyframes rainbow-text { 0% {color: red} 14% {color: orange} 28% {color: yellow} 42% {color: green} 57% {color: blue} 71% {color: indigo} 85% {color: violet} 100% {color: red} }
        .name-fx-41 { animation: rainbow-text 2s infinite; }
        @keyframes pulse-name { 0% {transform: scale(1)} 50% {transform: scale(1.1)} 100% {transform: scale(1)} }
        .name-fx-42 { display: inline-block; animation: pulse-name 1s infinite; }
        @keyframes shake-name { 0% {transform: translate(0,0)} 25% {transform: translate(1px,1px)} 50% {transform: translate(-1px,-1px)} 75% {transform: translate(1px,-1px)} 100% {transform: translate(0,0)} }
        .name-fx-43 { display: inline-block; animation: shake-name 0.5s infinite; }
        @keyframes glow-flash { 0% {text-shadow: 0 0 5px red} 50% {text-shadow: 0 0 20px yellow} 100% {text-shadow: 0 0 5px red} }
        .name-fx-44 { animation: glow-flash 2s infinite; color: white; }
        .name-fx-45 { animation: glitch-anim 2s infinite; }
        .name-fx-46 { background: linear-gradient(90deg, #f00, #ff0, #0f0, #0ff, #00f, #f0f, #f00); background-size: 200%; -webkit-background-clip: text; color: transparent; animation: bg-anim-1 2s linear infinite; }
        .name-fx-47 { text-decoration: underline; animation: pulse-name 2s infinite; }
        .name-fx-48 { border-bottom: 2px solid transparent; animation: border-pulse 1s infinite; }
        @keyframes border-pulse { 0% {border-color: red} 100% {border-color: blue} }
        .name-fx-49 { filter: hue-rotate(0deg); animation: hue-spin 5s infinite; color: red; }
        @keyframes hue-spin { 100% {filter: hue-rotate(360deg)} }
        .name-fx-50 { display: inline-block; transform: rotate(5deg); border: 1px solid white; padding: 1px; background: red; color: white; }

        /* --- BIO STYLES --- */
        .bio-fx-1 { font-family: sans-serif; }
        .bio-fx-2 { font-family: 'Press Start 2P'; font-size: 0.8em; line-height: 1.5; }
        .bio-fx-3 { font-family: 'Comic Neue'; font-weight: bold; }
        .bio-fx-4 { font-family: monospace; color: #00ff00; }
        .bio-fx-5 { font-family: serif; font-style: italic; color: #ffaaff; }
        .bio-fx-6 { color: #888; }
        .bio-fx-7 { color: #fff; text-align: center; }
        .bio-fx-8 { color: #ff00ff; text-align: right; }
        .bio-fx-9 { border-left: 2px solid white; padding-left: 5px; }
        .bio-fx-10 { border-right: 2px solid red; padding-right: 5px; text-align: right; }
        .bio-fx-11 { background: #111; padding: 5px; border: 1px solid #333; }
        .bio-fx-12 { background: #222; color: #00ff00; padding: 5px; font-family: monospace; }
        .bio-fx-13 { text-shadow: 1px 1px 0 #000; }
        .bio-fx-14 { text-shadow: 0 0 5px #ff00ff; }
        .bio-fx-15 { letter-spacing: 1px; }
        .bio-fx-16 { font-family: 'Rubik Glitch'; }
        .bio-fx-17 { font-family: 'Creepster'; color: #aa0000; }
        .bio-fx-18 { font-family: 'VT323'; font-size: 1.2em; }
        .bio-fx-19 { font-family: 'Orbitron'; font-size: 0.8em; color: #00ffff; }
        .bio-fx-20 { font-family: 'Rye'; }
        .bio-fx-21 { text-decoration: underline; }
        .bio-fx-22 { text-decoration: line-through; }
        .bio-fx-23 { background: linear-gradient(to right, #000, #222); padding: 5px; }
        .bio-fx-24 { border: 1px dashed #555; padding: 5px; }
        .bio-fx-25 { color: yellow; }
        .bio-fx-26 { color: cyan; }
        .bio-fx-27 { color: magenta; }
        .bio-fx-28 { transform: rotate(1deg); }
        .bio-fx-29 { transform: rotate(-1deg); }
        .bio-fx-30 { font-weight: 100; }
        .bio-fx-31 { font-weight: 900; }
        .bio-fx-32 { color: transparent; -webkit-text-stroke: 0.5px white; }
        .bio-fx-33 { background: rgba(255,255,255,0.1); padding: 5px; }
        .bio-fx-34 { background: rgba(255,0,0,0.1); padding: 5px; border: 1px solid red; }
        .bio-fx-35 { background: rgba(0,255,0,0.1); padding: 5px; border: 1px solid green; }
        .bio-fx-36 { background: rgba(0,0,255,0.1); padding: 5px; border: 1px solid blue; }
        .bio-fx-37 { border-top: 1px solid white; border-bottom: 1px solid white; padding: 5px 0; }
        .bio-fx-38 { font-variant: small-caps; }
        .bio-fx-39 { word-spacing: 5px; }
        .bio-fx-40 { opacity: 0.5; transition: opacity 0.2s; } .bio-fx-40:hover { opacity: 1; }
        .bio-fx-41 { animation: pulse-name 2s infinite; }
        .bio-fx-42 { animation: rainbow-text 5s infinite; }
        .bio-fx-43 { animation: glitch-anim 5s infinite; }
        .bio-fx-44 { background: repeating-linear-gradient(45deg, #000, #000 5px, #111 5px, #111 10px); padding: 5px; }
        .bio-fx-45 { border-radius: 10px; border: 1px solid white; padding: 5px; }
        .bio-fx-46 { box-shadow: 5px 5px 0 #333; background: #000; padding: 5px; border: 1px solid #555; }
        .bio-fx-47 { filter: blur(0.3px); }
        .bio-fx-48 { color: #fff; background: #000; mix-blend-mode: difference; }
        .bio-fx-49 { background: linear-gradient(90deg, red, blue); -webkit-background-clip: text; color: transparent; }
        .bio-fx-50 { font-family: 'Wingdings'; } /* Chaos option */

        /* --- TEXT COLOR OPTIONS --- */
        .msg-text-1 { color: #ffffff; }
        .msg-text-2 { color: #00ff00; }
        .msg-text-3 { color: #ff00ff; }
        .msg-text-4 { color: #00ffff; }
        .msg-text-5 { color: #ffff00; }
        .msg-text-6 { color: #ff0000; }
        .msg-text-7 { color: #0000ff; }
        .msg-text-8 { color: #ffa500; }
        .msg-text-9 { color: #800080; }
        .msg-text-10 { color: #ffc0cb; }
        .msg-text-11 { color: #a52a2a; }
        .msg-text-12 { color: #808080; }
        .msg-text-13 { color: #c0c0c0; }
        .msg-text-14 { color: #ffd700; }
        .msg-text-15 { color: #adff2f; }
        .msg-text-16 { color: #00fa9a; }
        .msg-text-17 { color: #00ced1; }
        .msg-text-18 { color: #4682b4; }
        .msg-text-19 { color: #da70d6; }
        .msg-text-20 { color: #ff1493; }
        .msg-text-21 { color: #dc143c; }
        .msg-text-22 { color: #ff4500; }
        .msg-text-23 { color: #2e8b57; }
        .msg-text-24 { color: #20b2aa; }
        .msg-text-25 { color: #1e90ff; }
        .msg-text-26 { color: #9370db; }
        .msg-text-27 { color: #7b68ee; }
        .msg-text-28 { color: #6a5acd; }
        .msg-text-29 { color: #483d8b; }
        .msg-text-30 { color: #191970; }
        .msg-text-31 { color: #d2691e; }
        .msg-text-32 { color: #8b4513; }
        .msg-text-33 { color: #f4a460; }
        .msg-text-34 { color: #d8bfd8; }
        .msg-text-35 { color: #dda0dd; }
        .msg-text-36 { color: #ee82ee; }
        .msg-text-37 { color: #f0e68c; }
        .msg-text-38 { color: #bdb76b; }
        .msg-text-39 { color: #9acd32; }
        .msg-text-40 { color: #6b8e23; }
        .msg-text-41 { color: #556b2f; }
        .msg-text-42 { color: #008080; }
        .msg-text-43 { color: #48d1cc; }
        .msg-text-44 { color: #00bfff; }
        .msg-text-45 { color: #87ceeb; }
        .msg-text-46 { color: #b0c4de; }
        .msg-text-47 { background: linear-gradient(to right, #f00, #ff0, #0f0, #0ff, #00f, #f0f, #f00); -webkit-background-clip: text; color: transparent; animation: rainbow-text 5s infinite; font-weight: bold; }
        .msg-text-48 { text-shadow: 0 0 5px #fff; }
        .msg-text-49 { background: linear-gradient(to right, #ff00ff, #00ffff); -webkit-background-clip: text; color: transparent; font-weight: bold; }
        .msg-text-50 { color: #333; -webkit-text-stroke: 0.5px white; }

    </style>
</head>
<body class="bg-chaos h-screen w-screen flex flex-col items-center justify-center text-white relative">

    <!-- HIDDEN INPUTS FOR UPLOADS -->
    <input type="file" id="main-file-input" hidden accept="image/*">
    <input type="file" id="pm-file-input" hidden accept="image/*">

    <!-- CONTENT WRAPPER (FULL SCREEN, NO SCALE) -->
    <div class="relative z-20 w-full h-full flex items-center justify-center p-2 md:p-4">
        
        <!-- CHAT WINDOW (Almost Full Screen) -->
        <div class="w-full h-full bg-gray-900 border-4 border-white flex brutal-shadow relative z-10 overflow-hidden">
            
            <!-- MAIN CHAT AREA (Left Side) -->
            <main class="flex-1 flex flex-col relative border-r-4 border-white bg-black/20">
                
                <!-- TOP BAR -->
                <header class="h-12 border-b-4 border-white bg-black flex items-center justify-between px-4 shadow-xl z-30">
                    <div class="flex items-center gap-3">
                        <button class="md:hidden text-lg">üçî</button>
                        <h1 class="font-glitch text-xl md:text-2xl" data-text="#GENERAL_CHAOS">#GENERAL_CHAOS</h1>
                    </div>
                    
                    <div class="flex items-center gap-4">
                         <div class="font-pixel text-[10px] text-yellow-300 animate-pulse hidden md:block">
                            CHAOS: 9000%
                        </div>

                        <!-- INBOX BUTTON -->
                        <div class="relative cursor-pointer group" id="inbox-btn">
                            <span class="text-2xl group-hover:scale-110 transition-transform block">üì©</span>
                            <span id="inbox-dot" class="absolute -top-1 -right-1 bg-red-600 rounded-full w-3 h-3 hidden animate-ping"></span>
                        </div>
                        
                        <!-- NOTIFICATION BELL -->
                        <div class="relative cursor-pointer group" id="notif-btn">
                            <span class="text-2xl group-hover:scale-110 transition-transform block">üîî</span>
                            <span id="notif-badge" class="absolute -top-1 -right-1 bg-red-600 text-white text-[8px] font-pixel w-4 h-4 flex items-center justify-center border border-white hidden animate-bounce">0</span>
                        </div>
                    </div>
                </header>

                <!-- INBOX PANEL (Dropdown) -->
                <div id="inbox-panel" class="absolute top-12 right-14 w-64 bg-black border-4 border-white z-50 hidden flex flex-col max-h-[50vh]">
                     <div class="bg-purple-900 p-2 border-b-4 border-white flex justify-between items-center">
                        <span class="font-pixel text-[10px] text-white">DIRECT_LINKS</span>
                        <div class="flex items-center gap-2">
                             <span class="text-[8px] font-bold">FRIENDS ONLY</span>
                             <input type="checkbox" id="inbox-filter-toggle" class="cursor-pointer">
                        </div>
                    </div>
                    <div id="inbox-list" class="overflow-y-auto p-0 flex-1">
                        <!-- Inbox items injected here -->
                        <div class="text-center text-gray-500 font-pixel text-[8px] py-4">VOID IS EMPTY</div>
                    </div>
                </div>

                <!-- NOTIFICATION PANEL (Dropdown) -->
                <div id="notif-panel" class="absolute top-12 right-2 w-72 bg-gray-900 border-4 border-white brutal-shadow z-50 hidden flex flex-col max-h-[50vh] shadow-[0_0_20px_rgba(0,0,0,0.8)]">
                    <div class="bg-black p-2 border-b-4 border-white flex justify-between items-center sticky top-0 z-10">
                        <span class="font-pixel text-[10px] text-white">SYSTEM_LOGS</span>
                        <button id="clear-notifs" class="text-[8px] bg-red-600 text-white px-2 py-1 hover:bg-red-500 font-pixel border border-white active:translate-y-1">NUKE ALL</button>
                    </div>
                    <div id="notif-list" class="overflow-y-auto p-2 space-y-2 flex-1">
                        <!-- Items Injected Here -->
                        <div class="text-center text-gray-500 font-pixel text-[8px] py-4" id="empty-msg">NO NEW DATA</div>
                    </div>
                </div>

                <!-- MESSAGES FEED -->
                <div id="message-feed" class="flex-1 overflow-y-auto p-4 space-y-4 scroll-smooth pb-20">
                    <!-- Messages will be injected here by Firebase -->
                    <div class="text-center my-2">
                        <span class="bg-yellow-400 text-black px-3 py-1 font-pixel text-[10px] border-2 border-white inline-block transform -rotate-1">
                            SYSTEM: CONNECTING TO HIVE MIND...
                        </span>
                    </div>
                </div>

                <!-- INPUT AREA -->
                <div class="h-16 bg-black border-t-4 border-white p-2 flex items-center gap-3 z-30 relative">
                    <!-- MAIN CHAT ATTACHMENT -->
                    <button id="main-attach-btn" class="h-10 w-10 border-2 border-white bg-gray-800 text-lg hover:bg-gray-700 active:scale-95 shadow-[2px_2px_0_#fff]">
                        üìé
                    </button>
                    <!-- PREVIEW CONTAINER -->
                    <div id="main-preview" class="hidden w-10 h-10 border border-white overflow-hidden relative">
                         <img src="" class="w-full h-full object-cover opacity-50">
                         <div class="absolute inset-0 flex items-center justify-center text-white text-xs font-bold bg-black/50">1</div>
                    </div>

                    <input id="msg-input" autocomplete="off" type="text" placeholder="SCREAM INTO THE VOID..." class="flex-1 h-10 bg-gray-900 border-2 border-white px-3 text-white text-sm font-bold focus:outline-none focus:bg-gray-800 focus:shadow-[inset_0_0_10px_#ff00ff] transition-all">
                    <button id="send-btn" class="brutal-btn h-10 px-4 text-xs font-bold hover:bg-pink-500 active:bg-pink-700">
                        SCREAM
                    </button>
                </div>
            </main>

            <!-- RIGHT SIDEBAR (Online Players) -->
            <aside class="w-56 bg-black flex flex-col z-20 border-l-4 border-white hidden md:flex">
                <div class="p-3 border-b-4 border-white bg-gray-900">
                     <h2 class="font-pixel text-[10px] text-pink-400 mb-1">ONLINE_DEGENERATES</h2>
                     <p class="text-[10px] text-gray-400">DETECTING SOULS...</p>
                </div>
                
                <div id="online-list" class="flex-1 overflow-y-auto p-3 space-y-3">
                    <!-- Populated via JS -->
                </div>

                <div class="p-3 border-t-4 border-white bg-gray-900 flex flex-col gap-2">
                    <button id="my-profile-btn" class="w-full border-2 border-white p-2 font-pixel text-[10px] bg-blue-600 hover:bg-blue-500 text-white shadow-[2px_2px_0_white] active:translate-x-1 active:translate-y-1 active:shadow-none transition-all">
                        MY_PROFILE
                    </button>
                    <button id="logout-btn" class="w-full border-2 border-white p-2 font-pixel text-[10px] bg-red-600 hover:bg-red-500 text-white shadow-[2px_2px_0_white] active:translate-x-1 active:translate-y-1 active:shadow-none transition-all">
                        RAGE_QUIT
                    </button>
                </div>
            </aside>

        </div>
    </div>

    <!-- CONTEXT MENU -->
    <div id="context-menu">
        <button id="ctx-profile">VIEW PROFILE</button>
        <button id="ctx-pm">PM USER</button>
        <button id="ctx-add-friend" class="text-green-400">ADD FRIEND</button>
        <button id="ctx-block" class="text-red-500 hover:bg-red-900">BLOCK</button>
        <button id="ctx-unblock" class="text-yellow-500 hover:bg-yellow-900 hidden">UNBLOCK</button>
        <button id="ctx-action" class="hidden text-red-500 border-t-2 border-red-500">ADMIN NUKE</button>
    </div>

    <!-- PM CONTAINER (For Draggable Windows) -->
    <div id="pm-container"></div>
    
    <!-- LIGHTBOX -->
    <div id="lightbox" class="fixed inset-0 z-[999] hidden flex items-center justify-center cursor-zoom-out" onclick="this.classList.add('hidden')">
        <img id="lightbox-img" src="" class="max-w-full max-h-full" onclick="event.stopPropagation()">
    </div>

    <!-- BACKGROUND FLOATING IMAGES (Decor) -->
    <img src="https://media1.tenor.com/m/m1M773lCgYAAAAAC/doge.gif" class="floating-img top-10 right-10 w-24" style="animation: spin 10s linear infinite;">
    <img src="https://media1.tenor.com/m/N5a92wH3wKkAAAAC/cat-stare.gif" class="floating-img bottom-40 left-10 w-32 filter grayscale contrast-200">

    <!-- PROFILE MODAL (Hidden by default) -->
    <div id="profile-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-screen h-screen bg-black/80 backdrop-blur-sm pointer-events-auto">
        <!-- MODAL CONTAINER: Responsive Flex Layout (Col on mobile, Row on desktop when customized) -->
        <div id="modal-content-container" class="bg-gray-900 border-4 border-white w-full max-w-md transition-all duration-300 flex flex-col md:flex-row overflow-hidden brutal-shadow relative mx-4 max-h-[90vh]">
           
           <!-- LEFT SIDE: Normal Profile Content (Preview) -->
           <div id="profile-view" class="w-full md:w-full flex-shrink-0 flex flex-col relative transition-all duration-300 overflow-y-auto">
               <!-- Banner -->
               <div class="h-32 bg-purple-900 relative overflow-hidden group flex-shrink-0">
                   <img id="modal-banner" class="w-full h-full object-cover opacity-80" src="https://media.giphy.com/media/26tn33aiTi1jkl6H6/giphy.gif">
                   <div id="banner-overlay" class="absolute inset-0 bg-black/50 hidden items-center justify-center cursor-pointer edit-overlay text-white font-pixel text-[10px]">
                       <span>UPLOAD BANNER (Max 2MB)</span>
                       <input type="file" id="upload-banner" class="hidden" accept="image/*">
                   </div>
               </div>
               
               <!-- PFP -->
               <div class="absolute top-20 left-4 w-24 h-24 border-4 border-white bg-black z-10 group">
                   <img id="modal-pfp" class="w-full h-full object-cover" src="https://api.dicebear.com/7.x/pixel-art/svg?seed=Meme">
                   <div id="pfp-overlay" class="absolute inset-0 bg-black/50 hidden items-center justify-center cursor-pointer edit-overlay text-white font-pixel text-[8px]">
                       <span>UPLOAD PFP (Max 1MB)</span>
                       <input type="file" id="upload-pfp" class="hidden" accept="image/*">
                   </div>
               </div>
               
               <!-- Content -->
               <div class="mt-14 p-4 flex-grow">
                   <h2 id="modal-name" class="font-glitch text-2xl mb-1 truncate text-white" data-text="LOADING...">LOADING...</h2>
                   
                   <!-- Read Mode Info -->
                   <div id="read-mode-info">
                        <div class="flex gap-2 text-[10px] font-pixel text-gray-400 mb-4">
                            <span id="modal-age">LVL: ??</span> | <span id="modal-gender">CLASS: UNKNOWN</span>
                        </div>
                        <!-- BIO DISPLAY: Scrollable & Max Height -->
                        <p id="modal-bio" class="text-sm font-bold text-pink-400 mb-4 border-l-4 border-pink-500 pl-2 min-h-[3rem] max-h-32 overflow-y-auto whitespace-pre-wrap break-words pr-2">Loading bio...</p>
                   </div>
      
                   <!-- Edit Mode Inputs (Hidden) -->
                   <div id="edit-form" class="hidden space-y-2 mb-4">
                      <div class="flex gap-2">
                        <input id="input-age" autocomplete="off" placeholder="AGE/LVL" class="bg-black border border-white p-2 text-white text-xs w-1/2 font-pixel focus:outline-none focus:bg-gray-800">
                        <input id="input-gender" autocomplete="off" placeholder="GENDER/CLASS" class="bg-black border border-white p-2 text-white text-xs w-1/2 font-pixel focus:outline-none focus:bg-gray-800">
                      </div>
                      <!-- BIO INPUT: Char Limit -->
                      <textarea id="input-bio" autocomplete="off" maxlength="280" placeholder="WRITE YOUR LORE (MAX 280 CHARS)..." class="bg-black border border-white p-2 text-white text-xs w-full h-24 font-bold focus:outline-none focus:bg-gray-800 resize-none"></textarea>
                      <div class="text-[8px] text-right text-gray-500 font-pixel mt-1">LIMIT: 280 CHARS</div>
                   </div>
      
                   <!-- Stats & Actions -->
                   <div class="flex justify-between items-center border-t-2 border-gray-700 pt-4 flex-wrap gap-2 mb-4">
                       <div class="flex items-center gap-2 group cursor-pointer" id="like-container">
                           <button id="btn-like" class="text-2xl transition-transform group-hover:scale-125 group-active:scale-90 grayscale">üî•</button>
                           <span id="modal-likes" class="font-pixel text-yellow-400 text-xs">0 SOULS</span>
                       </div>
                       <div class="flex gap-2 flex-wrap justify-end">
                           <button id="btn-poke" class="brutal-btn px-3 py-2 text-[10px] bg-purple-600 hover:bg-purple-500 hidden">üëâ POKE</button>
                           <button id="btn-customize" class="brutal-btn px-3 py-2 text-[10px] bg-yellow-600 hover:bg-yellow-500 hidden">CUSTOMIZE</button>
                           <button id="btn-edit" class="brutal-btn px-3 py-2 text-[10px] hidden hover:bg-pink-400">EDIT_DATA</button>
                           <button id="btn-save" class="brutal-btn px-3 py-2 text-[10px] bg-green-600 hidden hover:bg-green-500">SAVE_GAME</button>
                           <button id="btn-close" class="border-2 border-white px-3 py-2 text-[10px] hover:bg-white hover:text-black font-pixel transition-colors text-white bg-black">CLOSE</button>
                       </div>
                   </div>
               </div>
           </div>
           
           <!-- RIGHT SIDE: Customization Container (Injected via JS) -->
           <!-- Hidden by default, appears side-by-side when customizing -->
           <div id="customization-view" class="hidden flex-1 flex flex-col bg-gray-900 h-full overflow-hidden border-t-4 md:border-t-0 md:border-l-4 border-white min-w-[300px] md:w-[400px]">
                <!-- Dynamic content injected here -->
           </div>
        </div>
      </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, doc, getDoc, setDoc, updateDoc, deleteDoc, arrayUnion, arrayRemove, query, orderBy, limit, onSnapshot, serverTimestamp, where } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        // Import Customization
        import { initCustomizationUI, applyProfileStyles } from "./customization.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDY-nLKffz3IYCm-4TRLr-0snNZH4zclt8",
            authDomain: "memechat-fb77d.firebaseapp.com",
            projectId: "memechat-fb77d",
            storageBucket: "memechat-fb77d.firebasestorage.app",
            messagingSenderId: "1096551414056",
            appId: "1:1096551414056:web:a1734311eda4a1f459f81d",
            measurementId: "G-8QKBE680RZ"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        const feed = document.getElementById('message-feed');
        const input = document.getElementById('msg-input');
        const sendBtn = document.getElementById('send-btn');
        const mainAttachBtn = document.getElementById('main-attach-btn');
        const mainPreview = document.getElementById('main-preview');
        const mainFileInput = document.getElementById('main-file-input');
        const pmFileInput = document.getElementById('pm-file-input');
        const logoutBtn = document.getElementById('logout-btn');
        const onlineList = document.getElementById('online-list');
        const myProfileBtn = document.getElementById('my-profile-btn');

        // Modal Elements
        const modal = document.getElementById('profile-modal');
        const modalContainer = document.getElementById('modal-content-container');
        const profileView = document.getElementById('profile-view');
        const customizationView = document.getElementById('customization-view');
        const modalName = document.getElementById('modal-name');
        const modalBio = document.getElementById('modal-bio');
        const modalAge = document.getElementById('modal-age');
        const modalGender = document.getElementById('modal-gender');
        const modalPfp = document.getElementById('modal-pfp');
        const modalBanner = document.getElementById('modal-banner');
        const modalLikes = document.getElementById('modal-likes');
        
        const btnEdit = document.getElementById('btn-edit');
        const btnSave = document.getElementById('btn-save');
        const btnClose = document.getElementById('btn-close');
        const btnLike = document.getElementById('btn-like');
        const btnPoke = document.getElementById('btn-poke');
        const btnCustomize = document.getElementById('btn-customize');
        
        const readModeInfo = document.getElementById('read-mode-info');
        const editForm = document.getElementById('edit-form');
        const inputBio = document.getElementById('input-bio');
        const inputAge = document.getElementById('input-age');
        const inputGender = document.getElementById('input-gender');
        
        const bannerOverlay = document.getElementById('banner-overlay');
        const pfpOverlay = document.getElementById('pfp-overlay');
        const uploadBanner = document.getElementById('upload-banner');
        const uploadPfp = document.getElementById('upload-pfp');
        
        // Notification Elements
        const notifBtn = document.getElementById('notif-btn');
        const notifPanel = document.getElementById('notif-panel');
        const notifList = document.getElementById('notif-list');
        const notifBadge = document.getElementById('notif-badge');
        const clearNotifsBtn = document.getElementById('clear-notifs');
        const emptyMsg = document.getElementById('empty-msg');
        
        // Inbox & Context Menu
        const inboxBtn = document.getElementById('inbox-btn');
        const inboxPanel = document.getElementById('inbox-panel');
        const inboxList = document.getElementById('inbox-list');
        const inboxDot = document.getElementById('inbox-dot');
        const inboxFilterToggle = document.getElementById('inbox-filter-toggle');
        
        const contextMenu = document.getElementById('context-menu');
        const ctxProfile = document.getElementById('ctx-profile');
        const ctxPm = document.getElementById('ctx-pm');
        const ctxAddFriend = document.getElementById('ctx-add-friend');
        const ctxBlock = document.getElementById('ctx-block');
        const ctxUnblock = document.getElementById('ctx-unblock');
        const ctxAction = document.getElementById('ctx-action');
        
        const pmContainer = document.getElementById('pm-container');
        const lightbox = document.getElementById('lightbox');
        const lightboxImg = document.getElementById('lightbox-img');

        let currentUser = null;
        let currentProfileUid = null;
        // Updated Map to store full user data including styles
        let activeUsersMap = new Map(); // Store display names, avatars, styles
        let currentUserPfp = "https://api.dicebear.com/7.x/pixel-art/svg?seed=Meme"; // Track local user PFP
        let myProfileStyles = {}; // Cache local styles

        let myFriends = new Set();
        let myBlocked = new Set();
        let chatInitialized = false; // Prevent double init

        let notifications = [];
        let unreadCount = 0;
        let viewedProfilesSession = new Set(); // Prevent spamming views in one session
        
        // PM State
        let selectedUserForContext = null;
        let activePMWindows = new Set();
        let inboxData = new Map(); // uid -> { count, pfp, name }
        let pmHistory = new Map(); // uid -> [{msg data}, ...] for persistence
        
        // Image Upload State
        let pendingMainImage = null;
        let activePMWindowIdForUpload = null;
        let pmPendingImages = new Map(); // windowId -> base64

        // Default Assets
        const DEFAULT_AVATAR = "https://api.dicebear.com/7.x/pixel-art/svg?seed=Meme";
        const DEFAULT_BANNER = "https://media.giphy.com/media/26tn33aiTi1jkl6H6/giphy.gif";

        // --- AUTH CHECK ---
        onAuthStateChanged(auth, (user) => {
            if (!user) {
                window.location.href = "/index";
            } else {
                currentUser = user;
                if(!chatInitialized) {
                    chatInitialized = true;
                    initChat();
                    listenToMyProfile();
                    listenForRemoteNotifications();
                    initPMSystem(); // Initialize PM listeners
                    listenToFriendsAndBlocked();
                    listenToFriendRequests();
                }
            }
        });

        // --- LOGOUT ---
        logoutBtn.addEventListener('click', () => {
            signOut(auth).then(() => window.location.href = "/index");
        });

        // --- SOUNDS ---
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        const ac = new AudioContext();
        function beep(freq = 150, type = 'sawtooth') {
            if(ac.state === 'suspended') ac.resume();
            const osc = ac.createOscillator();
            const g = ac.createGain();
            osc.connect(g);
            g.connect(ac.destination);
            osc.type = type;
            osc.frequency.setValueAtTime(freq, ac.currentTime);
            osc.frequency.exponentialRampToValueAtTime(0.01, ac.currentTime + 0.1);
            osc.start();
            osc.stop(ac.currentTime + 0.1);
        }
        
        // --- BASE64 HELPER ---
        const toBase64 = file => new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result);
            reader.onerror = error => reject(error);
        });

        // --- FRIENDS & BLOCKING LOGIC ---
        function listenToFriendsAndBlocked() {
             onSnapshot(doc(db, "users", currentUser.uid), (docSnap) => {
                if(docSnap.exists()) {
                    const data = docSnap.data();
                    myFriends = new Set(data.friends || []);
                    myBlocked = new Set(data.blocked || []);
                    
                    updateOnlineList();
                    renderInbox();
                    
                    // Refresh PM Window Request Banners
                    document.querySelectorAll('.pm-window').forEach(win => {
                        const uid = win.id.replace('pm-window-', '');
                        const banner = win.querySelector('.req-banner');
                        if (myFriends.has(uid)) {
                            if(banner) banner.remove();
                        } else if (!banner) {
                            const header = win.querySelector('.pm-header');
                            const b = document.createElement('div');
                            b.className = "req-banner bg-yellow-600 text-[8px] p-1 text-center font-bold";
                            b.innerText = "MESSAGE REQUEST - NOT FRIENDS";
                            header.after(b);
                        }
                    });
                }
             });
        }
        
        function listenToFriendRequests() {
            const q = query(
                collection(db, "friend_requests"),
                where("to", "==", currentUser.uid),
                where("status", "==", "pending")
            );
            
            onSnapshot(q, (snapshot) => {
                snapshot.docChanges().forEach((change) => {
                    if (change.type === "added") {
                        const data = change.doc.data();
                        addFriendRequestNotification(change.doc.id, data.fromName, data.from);
                    }
                });
            });
        }

        function addFriendRequestNotification(reqId, name, uid) {
            const div = document.createElement('div');
            div.className = "p-2 border border-green-500 bg-gray-900 mb-2";
            div.innerHTML = `
                <div class="text-[10px] text-green-400 mb-1">FRIEND REQUEST: ${name}</div>
                <div class="flex gap-2">
                    <button class="req-btn req-accept" onclick="window.handleFriendReq('${reqId}', '${uid}', true)">ACCEPT</button>
                    <button class="req-btn req-decline" onclick="window.handleFriendReq('${reqId}', '${uid}', false)">DECLINE</button>
                </div>
            `;
            // Prepend to notif list
            if(notifList.contains(emptyMsg)) notifList.innerHTML = '';
            notifList.prepend(div);
            
            beep(1000, 'square');
            notifBadge.classList.remove('hidden');
            notifBadge.innerText = "!";
        }

        window.handleFriendReq = async (reqId, senderUid, accepted) => {
            const reqRef = doc(db, "friend_requests", reqId);
            if (accepted) {
                // Update both users friends list
                const batch = db.batch || null; 
                await updateDoc(doc(db, "users", currentUser.uid), {
                    friends: arrayUnion(senderUid)
                });
                 await updateDoc(doc(db, "users", senderUid), {
                    friends: arrayUnion(currentUser.uid)
                });
                await deleteDoc(reqRef);
                addNotification(`FRIEND ADDED: ${senderUid}`, 'success');
            } else {
                await deleteDoc(reqRef);
                addNotification("REQUEST DENIED", 'error');
            }
             renderNotifications(); 
        };
        
        // Context Menu Actions
        ctxAddFriend.onclick = async () => {
             if(!selectedUserForContext) return;
             const target = selectedUserForContext.uid;
             
             if (myFriends.has(target)) {
                 addNotification("ALREADY FRIENDS", "info");
                 contextMenu.style.display = 'none';
                 return;
             }
             
             await addDoc(collection(db, "friend_requests"), {
                 from: currentUser.uid,
                 fromName: currentUser.displayName,
                 to: target,
                 status: "pending",
                 createdAt: serverTimestamp()
             });
             addNotification("FRIEND REQUEST SENT", "success");
             contextMenu.style.display = 'none';
        };

        ctxBlock.onclick = async () => {
            if(!selectedUserForContext) return;
            const target = selectedUserForContext.uid;
            
            await updateDoc(doc(db, "users", currentUser.uid), {
                blocked: arrayUnion(target)
            });
            
            addNotification("USER BLOCKED", "error");
            contextMenu.style.display = 'none';
        };

        ctxUnblock.onclick = async () => {
            if(!selectedUserForContext) return;
            const target = selectedUserForContext.uid;
            
            await updateDoc(doc(db, "users", currentUser.uid), {
                blocked: arrayRemove(target)
            });
            
            addNotification("USER UNBLOCKED", "success");
            contextMenu.style.display = 'none';
        };


        // --- IMAGE HANDLING ---
        window.openLightbox = (src) => {
            lightboxImg.src = src;
            lightbox.classList.remove('hidden');
        };

        // Main Chat Attach
        mainAttachBtn.onclick = () => mainFileInput.click();
        mainFileInput.onchange = async (e) => {
            if(e.target.files[0]) {
                const file = e.target.files[0];
                if (file.size > 1024 * 1024) { 
                     addNotification("FILE TOO CHONKY (Max 1MB)", "error");
                     return;
                }
                pendingMainImage = await toBase64(file);
                mainPreview.classList.remove('hidden');
                mainPreview.querySelector('img').src = pendingMainImage;
                beep(600);
            }
        };
        
        // PM Chat Attach (Global handler)
        pmFileInput.onchange = async (e) => {
            if(e.target.files[0] && activePMWindowIdForUpload) {
                const file = e.target.files[0];
                if (file.size > 1024 * 1024) { 
                     addNotification("FILE TOO CHONKY (Max 1MB)", "error");
                     return;
                }
                const base64 = await toBase64(file);
                pmPendingImages.set(activePMWindowIdForUpload, base64);
                
                // Show preview in that window
                const win = document.getElementById(activePMWindowIdForUpload);
                if (win) {
                    const preview = win.querySelector('.pm-preview');
                    preview.classList.remove('hidden');
                    preview.querySelector('img').src = base64;
                }
                beep(600);
            }
        };

        // --- PM SYSTEM ---
        function initPMSystem() {
            // Listener for incoming messages
            // Using orderBy to get correct history sequence. Might fail if index is missing, added fallback.
            const qIncoming = query(collection(db, "private_messages"), where("receiverId", "==", currentUser.uid), orderBy("createdAt", "asc"), limit(100));
            onSnapshot(qIncoming, (snapshot) => {
                snapshot.docChanges().forEach((change) => {
                    if (change.type === "added") {
                        const data = change.doc.data();
                        if (myBlocked.has(data.senderId)) return;
                        handleNewPM(data, true);
                    }
                });
            }, (error) => {
                console.log("Fallback query due to missing index", error);
                const qFallback = query(collection(db, "private_messages"), where("receiverId", "==", currentUser.uid), limit(100));
                onSnapshot(qFallback, (snapshot) => {
                     snapshot.docChanges().forEach((change) => {
                        if (change.type === "added") {
                            const data = change.doc.data();
                            if (myBlocked.has(data.senderId)) return;
                            handleNewPM(data, true);
                        }
                     });
                });
            });

            // Listener for outgoing messages
            const qOutgoing = query(collection(db, "private_messages"), where("senderId", "==", currentUser.uid), orderBy("createdAt", "asc"), limit(100));
            onSnapshot(qOutgoing, (snapshot) => {
                snapshot.docChanges().forEach((change) => {
                     if (change.type === "added") {
                        const data = change.doc.data();
                        handleNewPM(data, false);
                     }
                });
            }, (error) => {
                 const qFallback = query(collection(db, "private_messages"), where("senderId", "==", currentUser.uid), limit(100));
                 onSnapshot(qFallback, (snapshot) => {
                    snapshot.docChanges().forEach((change) => {
                        if (change.type === "added") {
                            const data = change.doc.data();
                            handleNewPM(data, false);
                        }
                    });
                 });
            });
        }
        
        function handleNewPM(msg, isIncoming) {
            const partnerId = isIncoming ? msg.senderId : msg.receiverId;
            
            // Persist in Memory
            if (!pmHistory.has(partnerId)) {
                pmHistory.set(partnerId, []);
            }
            const hist = pmHistory.get(partnerId);
            const msgTime = msg.createdAt ? msg.createdAt.toMillis() : Date.now();
            msg._sortTime = msgTime; 
            
            // Check for dupes just in case (optional but safe)
            // Ideally we'd use message ID but for this structure we just push.
            hist.push(msg);
            hist.sort((a, b) => a._sortTime - b._sortTime);

            // 1. Update Inbox
            if (isIncoming) {
                let prev = inboxData.get(partnerId) || { count: 0, name: msg.senderName, pfp: msg.pfpURL };
                prev.count++;
                inboxData.set(partnerId, prev);
                
                if (inboxPanel.classList.contains('hidden')) {
                     inboxDot.classList.remove('hidden');
                     beep(800, 'sine');
                }
                renderInbox();
            }

            // 2. Update Window if exists
            const windowId = `pm-window-${partnerId}`;
            const existingWin = document.getElementById(windowId);
            if (existingWin) {
                const content = existingWin.querySelector('.pm-messages');
                renderPMBubble(content, msg, isIncoming);
                content.scrollTop = content.scrollHeight;
            }
        }
        
        function renderPMBubble(container, msg, isIncoming) {
            const bubbleRow = document.createElement('div');
            // Force Left Align for everyone
            bubbleRow.className = `flex gap-2 mb-2 w-full`;
            
            const pfp = isIncoming ? (msg.pfpURL || DEFAULT_AVATAR) : (currentUserPfp || DEFAULT_AVATAR);
            const name = isIncoming ? msg.senderName : currentUser.displayName;
            
            // Retrieve Styles from Message
            const savedStyles = msg.profileStyles || {};
            const nameStyle = savedStyles.name || '';
            const textColor = savedStyles.textColor || '';

            let imageHTML = '';
            if (msg.imageURL) {
                imageHTML = `<img src="${msg.imageURL}" class="max-w-[150px] border-2 border-white cursor-pointer hover:opacity-80 mb-1" onclick="window.openLightbox(this.src)">`;
            }

            bubbleRow.innerHTML = `
                <img src="${pfp}" class="w-6 h-6 rounded-full border border-white self-start mt-1">
                <div class="flex flex-col items-start max-w-[90%]">
                    <span class="text-[8px] text-gray-400 mb-0.5 font-bold ${nameStyle}">${name}</span>
                    <div class="message-bubble ${textColor} text-xs break-words">
                        ${imageHTML}
                        ${msg.text ? `<div>${escapeHtml(msg.text)}</div>` : ''}
                    </div>
                </div>
            `;
            container.appendChild(bubbleRow);
        }

        // --- INBOX UI ---
        inboxBtn.onclick = () => {
            const isHidden = inboxPanel.classList.contains('hidden');
            if (isHidden) {
                inboxPanel.classList.remove('hidden');
                inboxDot.classList.add('hidden'); // Clear alert
                renderInbox();
            } else {
                inboxPanel.classList.add('hidden');
            }
        };
        
        inboxFilterToggle.onchange = renderInbox;

        function renderInbox() {
            inboxList.innerHTML = '';
            
            const friendsOnly = inboxFilterToggle.checked;
            let hasItems = false;
            
            inboxData.forEach((data, uid) => {
                // Filter Blocked
                if (myBlocked.has(uid)) return;
                
                // Filter Friends Only
                if (friendsOnly && !myFriends.has(uid)) return;
                
                hasItems = true;
                const item = document.createElement('div');
                item.className = 'inbox-item flex items-center gap-2 p-2 cursor-pointer border-b border-gray-800';
                item.onclick = () => openPMWindow(uid, data.name, data.pfp);
                
                item.innerHTML = `
                    <div class="relative">
                         <img src="${data.pfp || DEFAULT_AVATAR}" class="w-8 h-8 rounded-full border border-white">
                         <span class="absolute -top-1 -right-1 bg-blue-600 text-[8px] rounded-full w-4 h-4 flex items-center justify-center font-bold">${data.count}</span>
                    </div>
                    <div class="flex-1">
                        <div class="font-bold text-[10px] text-white">${data.name}</div>
                        <div class="text-[8px] text-gray-500">Click to chat</div>
                    </div>
                `;
                inboxList.appendChild(item);
            });
            
            if (!hasItems) {
                 inboxList.innerHTML = '<div class="text-center text-gray-500 font-pixel text-[8px] py-4">VOID IS EMPTY</div>';
            }
        }

        // --- CONTEXT MENU LOGIC ---
        document.onclick = (e) => {
            if (!contextMenu.contains(e.target) && e.target.className.indexOf('user-item') === -1) {
                contextMenu.style.display = 'none';
            }
        };

        function showContextMenu(e, uid, name, pfp) {
            e.stopPropagation(); 
            selectedUserForContext = { uid, name, pfp };
            
            contextMenu.style.display = 'flex';
            contextMenu.style.top = `${e.clientY}px`;
            contextMenu.style.left = `${e.clientX}px`;
            
            if (currentUser.email === 'dev@gmail.com') {
                ctxAction.classList.remove('hidden');
            } else {
                ctxAction.classList.add('hidden');
            }
            
            // Adjust "Add Friend" if already friends
            if(myFriends.has(uid)) {
                ctxAddFriend.classList.add('hidden');
            } else {
                ctxAddFriend.classList.remove('hidden');
            }

            // Adjust Block/Unblock
            if (myBlocked.has(uid)) {
                ctxBlock.classList.add('hidden');
                ctxUnblock.classList.remove('hidden');
                ctxAddFriend.classList.add('hidden');
                ctxPm.classList.add('hidden'); 
            } else {
                ctxBlock.classList.remove('hidden');
                ctxUnblock.classList.add('hidden');
                ctxPm.classList.remove('hidden');
            }
        }

        ctxProfile.onclick = () => {
            if(selectedUserForContext) openProfile(selectedUserForContext.uid);
            contextMenu.style.display = 'none';
        };

        ctxPm.onclick = () => {
            if(selectedUserForContext) openPMWindow(selectedUserForContext.uid, selectedUserForContext.name, selectedUserForContext.pfp);
            contextMenu.style.display = 'none';
        };

        ctxAction.onclick = () => {
            alert("ADMIN ACTION: USER PURGED FROM REALITY (jk)");
            contextMenu.style.display = 'none';
        };

        // --- DRAGGABLE PM WINDOWS ---
        window.openPMWindow = async (uid, name, pfp) => {
            if (myBlocked.has(uid)) {
                addNotification("YOU BLOCKED THIS USER", "error");
                return;
            }
            
            const winId = `pm-window-${uid}`;
            if (document.getElementById(winId)) return; 

            const win = document.createElement('div');
            win.id = winId;
            win.className = 'pm-window';
            
            // Check friendship
            let bannerHTML = "";
            if (!myFriends.has(uid)) {
                bannerHTML = `<div class="req-banner bg-yellow-600 text-[8px] p-1 text-center font-bold">MESSAGE REQUEST - NOT FRIENDS</div>`;
            }

            win.innerHTML = `
                <div class="pm-header">
                    <div class="flex items-center gap-2">
                        <img src="${pfp || DEFAULT_AVATAR}" class="w-4 h-4 rounded-full">
                        <span class="font-pixel text-[10px] text-white">${name}</span>
                    </div>
                    <div class="flex gap-1">
                        <button class="text-gray-400 hover:text-yellow-400 text-xs" title="Pin Window" onclick="this.closest('.pm-window').classList.toggle('pinned')">üìå</button>
                        <button class="text-red-500 hover:text-white font-bold ml-1" onclick="document.getElementById('${winId}').remove()">X</button>
                    </div>
                </div>
                ${bannerHTML}
                <div class="pm-messages">
                    <!-- Chat loaded here -->
                </div>
                <!-- PREVIEW -->
                <div class="pm-preview hidden h-8 bg-gray-800 border-t border-white flex items-center px-2">
                    <img src="" class="h-6 w-6 object-cover border border-white">
                    <span class="text-[8px] text-gray-400 ml-2">Image attached</span>
                </div>
                <div class="pm-input-area">
                    <button class="text-lg hover:scale-110 transition-transform" onclick="triggerPMUpload('${winId}')">üìé</button>
                    <input type="text" class="flex-1 bg-black text-white text-[10px] p-1 border border-gray-600 focus:border-white focus:outline-none" placeholder="Whisper...">
                    <button class="bg-white text-black text-[10px] font-bold px-2 hover:bg-gray-300">SEND</button>
                </div>
            `;
            
            pmContainer.appendChild(win);
            makeDraggable(win, win.querySelector('.pm-header'));
            
            // Populate History
            const content = win.querySelector('.pm-messages');
            const hist = pmHistory.get(uid) || [];
            
            if (hist.length === 0) {
                 content.innerHTML = '<div class="text-gray-500 text-[8px] text-center mt-2">SECURE CHANNEL OPENED</div>';
            } else {
                 hist.forEach(msg => {
                   const isMsgIncoming = (msg.senderId === uid); 
                   renderPMBubble(content, msg, isMsgIncoming);
                });
                setTimeout(() => content.scrollTop = content.scrollHeight, 10);
            }

            // Setup Send Logic
            const input = win.querySelector('input');
            const btn = win.querySelector('button:last-child');
            
            const sendPM = async () => {
                const text = input.value.trim();
                const image = pmPendingImages.get(winId);
                
                if (!text && !image) return;
                
                input.value = '';
                pmPendingImages.delete(winId);
                win.querySelector('.pm-preview').classList.add('hidden');
                
                try {
                    await addDoc(collection(db, "private_messages"), {
                        senderId: currentUser.uid,
                        senderName: currentUser.displayName,
                        receiverId: uid,
                        text: text,
                        imageURL: image || null,
                        pfpURL: currentUserPfp,
                        profileStyles: myProfileStyles || {}, // Save styles
                        createdAt: serverTimestamp()
                    });
                } catch(e) {
                    console.error(e);
                }
            };
            
            btn.onclick = sendPM;
            input.onkeydown = (e) => { if(e.key === 'Enter') sendPM(); };
        };
        
        window.triggerPMUpload = (winId) => {
            activePMWindowIdForUpload = winId;
            pmFileInput.click();
        }

        function makeDraggable(el, handle) {
            let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
            handle.onmousedown = dragMouseDown;

            function dragMouseDown(e) {
                e.preventDefault();
                pos3 = e.clientX;
                pos4 = e.clientY;
                document.onmouseup = closeDragElement;
                document.onmousemove = elementDrag;
            }

            function elementDrag(e) {
                e.preventDefault();
                pos1 = pos3 - e.clientX;
                pos2 = pos4 - e.clientY;
                pos3 = e.clientX;
                pos4 = e.clientY;
                el.style.top = (el.offsetTop - pos2) + "px";
                el.style.left = (el.offsetLeft - pos1) + "px";
            }

            function closeDragElement() {
                document.onmouseup = null;
                document.onmousemove = null;
            }
        }

        // --- REMOTE NOTIFICATION LOGIC ---
        async function sendRemoteNotification(targetUid, type, message) {
            if(targetUid === currentUser.uid) return; 
            try {
                await addDoc(collection(db, "notifications"), {
                    recipientUid: targetUid,
                    senderUid: currentUser.uid,
                    senderName: currentUser.displayName || "ANON",
                    type: type,
                    message: message,
                    createdAt: serverTimestamp(),
                    read: false
                });
            } catch(e) {
                console.error("Failed to send notif", e);
            }
        }

        function listenForRemoteNotifications() {
            const bootTime = Date.now();
            const q = query(
                collection(db, "notifications"), 
                where("recipientUid", "==", currentUser.uid),
                limit(20) 
            );

            onSnapshot(q, (snapshot) => {
                snapshot.docChanges().forEach((change) => {
                    if (change.type === "added") {
                        const data = change.doc.data();
                        const notifTime = data.createdAt ? data.createdAt.toMillis() : Date.now();
                        if (notifTime > (bootTime - 2000)) {
                             addNotification(data.message, data.type);
                        }
                    }
                });
            });
        }

        // --- LOCAL NOTIFICATION CENTER UI ---
        function addNotification(message, type = 'info') {
            const notif = {
                id: Date.now() + Math.random(),
                message,
                type,
                timestamp: new Date().toLocaleTimeString()
            };
            notifications.unshift(notif); 
            unreadCount++;
            updateBadge();
            renderNotifications();
            
            if (type === 'error') beep(80, 'square');
            else if (type === 'poke') { beep(600, 'sine'); beep(800, 'sine'); }
            else if (type === 'mention') { beep(1000, 'sine'); }
            else beep(800, 'sawtooth');
        }

        function updateBadge() {
            if (unreadCount > 0) {
                notifBadge.classList.remove('hidden');
                notifBadge.innerText = unreadCount > 9 ? '9+' : unreadCount;
            } else {
                notifBadge.classList.add('hidden');
            }
        }

        function renderNotifications() {
            const items = notifList.querySelectorAll('.notif-item');
            items.forEach(el => el.remove());
            if(emptyMsg) emptyMsg.remove();
            
            if (notifications.length === 0 && notifList.children.length === 0) {
                notifList.appendChild(emptyMsg);
                return;
            }
            notifications.forEach((n) => {
                const item = document.createElement('div');
                let bgClass = 'bg-gray-800';
                let icon = '‚ÑπÔ∏è';

                if(n.type === 'error') { bgClass = 'bg-red-900/50'; icon = 'üíÄ'; }
                if(n.type === 'success') { bgClass = 'bg-green-900/50'; icon = 'üíæ'; }
                if(n.type === 'poke') { bgClass = 'bg-purple-900/50'; icon = 'üëâ'; }
                if(n.type === 'view') { bgClass = 'bg-blue-900/50'; icon = 'üëÄ'; }
                if(n.type === 'like') { bgClass = 'bg-yellow-900/50'; icon = 'üî•'; }
                if(n.type === 'mention') { bgClass = 'bg-pink-900/50'; icon = 'üì¢'; }

                item.className = `notif-item p-2 border border-white mb-2 flex justify-between items-start gap-2 ${bgClass}`;
                item.innerHTML = `
                    <div class="flex gap-2">
                        <span class="text-lg">${icon}</span>
                        <div>
                             <p class="text-[10px] font-bold text-white leading-tight">${n.message}</p>
                             <p class="text-[8px] text-gray-400 font-pixel mt-1">${n.timestamp}</p>
                        </div>
                    </div>
                    <button class="text-white hover:text-red-400 font-bold" onclick="window.deleteNotif(${n.id})">X</button>
                `;
                notifList.appendChild(item);
            });
        }

        notifBtn.addEventListener('click', () => {
            const isHidden = notifPanel.classList.contains('hidden');
            if (isHidden) {
                notifPanel.classList.remove('hidden');
                unreadCount = 0; 
                updateBadge();
            } else {
                notifPanel.classList.add('hidden');
            }
        });

        window.deleteNotif = (id) => {
            notifications = notifications.filter(n => n.id !== id);
            renderNotifications();
        };

        clearNotifsBtn.addEventListener('click', () => {
            notifications = [];
            notifList.innerHTML = '';
            notifList.appendChild(emptyMsg);
        });

        // --- LISTEN FOR MY PFP CHANGES ---
        function listenToMyProfile() {
            onSnapshot(doc(db, "users", currentUser.uid), (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    if (data.pfpURL) currentUserPfp = data.pfpURL;
                    if (data.profileStyles) myProfileStyles = data.profileStyles; // Cache local styles
                    updateOnlineList();
                }
            });
        }

        // --- CHAT LOGIC ---
        function initChat() {
            const q = query(collection(db, "messages"), orderBy("createdAt"), limit(50));
            let isFirstLoad = true;

            onSnapshot(q, async (snapshot) => {
                feed.innerHTML = ''; 
                
                 const sysDiv = document.createElement('div');
                 sysDiv.className = "text-center my-2";
                 sysDiv.innerHTML = `<span class="bg-yellow-400 text-black px-3 py-1 font-pixel text-[10px] border-2 border-white inline-block transform -rotate-1">SYSTEM: WELCOME ${currentUser.displayName ? currentUser.displayName.toUpperCase() : 'ANON'}</span>`;
                 feed.appendChild(sysDiv);

                 activeUsersMap.clear();

                for (const docSnap of snapshot.docs) {
                    const data = docSnap.data();
                    const isSelf = data.uid === currentUser.uid;
                    const date = data.createdAt ? data.createdAt.toDate().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : '...';
                    
                    if(data.uid) {
                        // Store styles in map for online list rendering
                         activeUsersMap.set(data.uid, { 
                             name: data.displayName, 
                             pfp: data.pfpURL,
                             profileStyles: data.profileStyles 
                         });
                    }
                    
                    const msgDiv = document.createElement('div');
                    // Force left align
                    msgDiv.className = "message-container";
                    
                    const pfpSrc = data.pfpURL || DEFAULT_AVATAR;
                    const avatarHTML = `<img src="${pfpSrc}" class="w-8 h-8 border-2 border-white bg-gray-800 object-cover cursor-pointer hover:border-pink-500 transition-colors ${isSelf ? 'grayscale' : ''}" onclick="window.openProfile('${data.uid}')">`;

                    let processedText = escapeHtml(data.text);
                    const myName = currentUser.displayName;

                    if (myName && data.text.includes(myName) && !isSelf) {
                        const regex = new RegExp(escapeRegExp(myName), 'g');
                        processedText = processedText.replace(regex, `<span class="glow-text">${myName}</span>`);
                    }

                    // Retrieve Styles stored on the message document
                    const savedStyles = data.profileStyles || {};
                    const nameStyle = savedStyles.name || '';
                    const textColor = savedStyles.textColor || '';

                    // Display actual name, not YOU
                    const displayName = data.displayName || 'ANON';
                    
                    const displayNameHTML = `<span class="font-bold text-xs mb-1 username-link ${nameStyle}" onclick="window.tagUser('${displayName}')">${displayName}</span>`;

                    let imageHTML = '';
                    if (data.imageURL) {
                        imageHTML = `<img src="${data.imageURL}" class="max-w-[200px] border-2 border-white cursor-pointer hover:opacity-80 mt-2" onclick="window.openLightbox(this.src)">`;
                    }

                    msgDiv.innerHTML = `
                        ${avatarHTML}
                        <div class="flex flex-col items-start max-w-[85%]">
                            <div class="flex items-baseline gap-2">
                                ${displayNameHTML} 
                                <span class="text-gray-500 text-[10px]">${date}</span>
                            </div>
                            <div class="message-bubble ${textColor} text-sm relative flex flex-col items-start">
                                ${processedText}
                                ${imageHTML}
                            </div>
                        </div>
                    `;
                    feed.appendChild(msgDiv);
                }
                
                feed.scrollTop = feed.scrollHeight;
                updateOnlineList();

                if (!isFirstLoad) {
                    snapshot.docChanges().forEach((change) => {
                        if (change.type === "added") {
                            const data = change.doc.data();
                            beep(150); 
                            if (currentUser.displayName && data.text.includes(currentUser.displayName) && data.uid !== currentUser.uid) {
                                addNotification(`MENTIONED BY ${data.displayName}`, 'mention');
                            }
                        }
                    });
                }
                isFirstLoad = false;
            });
        }
        
        function escapeRegExp(string) {
            return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }

        window.tagUser = (name) => {
            input.value += `${name} `;
            input.focus();
        };

        // Fetch all users to get styles for the Online List
        function updateOnlineListStylesListener() {
            onSnapshot(collection(db, "users"), (snapshot) => {
                snapshot.forEach(doc => {
                    const data = doc.data();
                    if(activeUsersMap.has(doc.id)) {
                        activeUsersMap.set(doc.id, {
                            ...activeUsersMap.get(doc.id),
                            profileStyles: data.profileStyles
                        });
                    }
                });
                updateOnlineList();
            });
        }
        
        // Trigger this
        updateOnlineListStylesListener();

        function updateOnlineList() {
            onlineList.innerHTML = '';
            
            // Render Me Synchronously using cached variable
            renderUserItem(currentUser.uid, currentUser.displayName || 'YOU', true, currentUserPfp, myProfileStyles);

            activeUsersMap.forEach((u, uid) => {
                if (uid !== currentUser.uid) {
                    renderUserItem(uid, u.name, false, u.pfp || DEFAULT_AVATAR, u.profileStyles);
                }
            });
        }

        function renderUserItem(uid, name, isSelf, pfpUrl, styles = {}) {
            const isBlocked = myBlocked.has(uid);

            const div = document.createElement('div');
            div.className = "user-item flex items-center gap-2 cursor-pointer transition-transform relative p-1 rounded";
            if (isBlocked) div.classList.add('opacity-50');
            
            // Apply Name Style to Online List
            const nameStyleClass = styles.name ? styles.name : '';
            // We don't apply background style to list item to keep it clean, but we apply name FX.

            div.onclick = (e) => {
                if (isSelf) openProfile(uid);
                else showContextMenu(e, uid, name, pfpUrl);
            };

            const nameClass = isSelf ? 'text-green-400' : (isBlocked ? 'text-red-500 line-through' : 'text-purple-400');
            const statusText = isBlocked ? 'BLOCKED' : 'Online';

            div.innerHTML = `
                <div class="relative pointer-events-none">
                    <img src="${pfpUrl}" class="w-8 h-8 border-2 border-white bg-blue-900 object-cover ${isBlocked ? 'grayscale' : ''}">
                    <div class="absolute -bottom-1 -right-1 w-2 h-2 ${isSelf ? 'bg-green-500' : (isBlocked ? 'bg-red-500' : 'bg-purple-500')} border border-black animate-pulse"></div>
                </div>
                <div class="pointer-events-none">
                    <p class="font-bold text-xs ${nameClass} ${nameStyleClass}">${name} ${isSelf ? '(YOU)' : ''}</p>
                    <p class="text-[9px] text-gray-500">${statusText}</p>
                </div>
            `;
            onlineList.appendChild(div);
        }

        async function sendMessage() {
            const text = input.value.trim();
            const image = pendingMainImage;

            if ((!text && !image) || !currentUser) return;
            
            input.value = '';
            pendingMainImage = null;
            mainPreview.classList.add('hidden');
            mainFileInput.value = '';

            try {
                await addDoc(collection(db, "messages"), {
                    text: text,
                    imageURL: image || null,
                    uid: currentUser.uid,
                    displayName: currentUser.displayName || 'Anon',
                    createdAt: serverTimestamp(),
                    pfpURL: currentUserPfp,
                    profileStyles: myProfileStyles || {} // Save current styles to message
                });
            } catch (e) {
                addNotification("MESSAGE LOST IN VOID", "error");
            }
        }

        input.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') sendMessage();
        });
        
        sendBtn.addEventListener('click', sendMessage);

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // --- PROFILE LOGIC ---
        
        window.openProfile = async (uid) => {
            currentProfileUid = uid;
            modal.classList.remove('hidden');
            
            // RESET LAYOUT TO DEFAULT (NARROW)
            modalContainer.classList.remove('max-w-5xl');
            modalContainer.classList.add('max-w-md');
            
            // RESET VIEWS
            // Ensure preview is visible and takes full width initially
            profileView.classList.remove('hidden', 'w-80', 'border-r-4');
            profileView.classList.add('w-full');
            
            // Hide Customization
            customizationView.classList.add('hidden');
            customizationView.innerHTML = ''; // Clear old instance

            beep(300);
            
            // Clear previous styles from modal container
            applyProfileStyles(modalContainer, { background: '', name: '', bio: '' });

            modalName.innerText = "LOADING...";
            modalBio.innerText = "...";
            modalAge.innerText = "LVL: ??";
            modalGender.innerText = "CLASS: ???";
            modalPfp.src = DEFAULT_AVATAR;
            modalBanner.src = DEFAULT_BANNER;
            modalLikes.innerText = "0 SOULS";
            btnLike.classList.add('grayscale');

            const isMe = (uid === currentUser.uid);
            
            if (!isMe && !viewedProfilesSession.has(uid)) {
                sendRemoteNotification(uid, "view", `SOMEONE IS PERCEIVING YOU...`);
                viewedProfilesSession.add(uid);
            }

            if (isMe) {
                btnEdit.classList.remove('hidden');
                btnCustomize.classList.remove('hidden'); // Show Customize
                btnSave.classList.add('hidden');
                btnPoke.classList.add('hidden');
            } else {
                btnEdit.classList.add('hidden');
                btnCustomize.classList.add('hidden');
                btnSave.classList.add('hidden');
                btnPoke.classList.remove('hidden');
            }
            
            toggleEditMode(false);

            try {
                const docRef = doc(db, "users", uid);
                const docSnap = await getDoc(docRef);
                
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    modalName.innerText = (data.displayName || "ANON").toUpperCase();
                    modalBio.innerText = data.bio || "No lore available.";
                    modalAge.innerText = `LVL: ${data.age || '0'}`;
                    modalGender.innerText = `CLASS: ${data.gender || 'NPC'}`;
                    if(data.pfpURL) modalPfp.src = data.pfpURL;
                    if(data.bannerURL) modalBanner.src = data.bannerURL;
                    
                    const likes = data.likedBy ? data.likedBy.length : 0;
                    modalLikes.innerText = `${likes} SOUL${likes !== 1 ? 'S' : ''}`;
                    
                    if (data.likedBy && data.likedBy.includes(currentUser.uid)) {
                        btnLike.classList.remove('grayscale');
                    }

                    // APPLY SAVED STYLES
                    if (data.profileStyles) {
                        applyProfileStyles(modalContainer, data.profileStyles);
                    } else {
                        // Defaults
                        applyProfileStyles(modalContainer, {background:'bg-theme-1', name:'name-fx-1', bio:'bio-fx-1'});
                    }

                    // Setup Customize Button Logic (Only if it's me)
                    if (isMe) {
                        btnCustomize.onclick = () => {
                            // SWITCH TO SPLIT SCREEN LAYOUT
                            modalContainer.classList.remove('max-w-md');
                            modalContainer.classList.add('max-w-5xl');
                            
                            // Adjust Left Panel (Preview) to be side-by-side
                            profileView.classList.remove('w-full');
                            profileView.classList.add('w-full', 'md:w-96', 'border-b-4', 'md:border-b-0', 'md:border-r-4');
                            
                            // Show Right Panel
                            customizationView.classList.remove('hidden');
                            
                            initCustomizationUI(customizationView, currentUser, db, data.profileStyles || {});
                        };
                    }

                } else {
                    modalName.innerText = activeUsersMap.get(uid)?.name?.toUpperCase() || "ANON";
                }
            } catch (e) {
                console.log(e);
                addNotification("ERROR ACCESSING SOUL DATA", "error");
            }
        };

        // POKE LOGIC
        btnPoke.onclick = async () => {
            if (!currentProfileUid || currentProfileUid === currentUser.uid) return;
            
            const lastPokeKey = `lastPoke_${currentProfileUid}`;
            const lastPokeTime = localStorage.getItem(lastPokeKey);
            const now = Date.now();
            
            if (lastPokeTime && now - parseInt(lastPokeTime) < 60000) {
                addNotification("CHILL. POKE RECHARGING (1 MIN).", "error");
                return;
            }

            btnPoke.innerText = "POKING...";
            await sendRemoteNotification(currentProfileUid, "poke", "YOU BEEN TOUCHED üëà");
            localStorage.setItem(lastPokeKey, now.toString());
            
            btnPoke.innerText = "POKED!";
            setTimeout(() => btnPoke.innerText = "üëâ POKE", 2000);
            addNotification("POKE DELIVERED", "success");
        };

        function toggleEditMode(isEdit) {
            if (isEdit) {
                readModeInfo.classList.add('hidden');
                editForm.classList.remove('hidden');
                btnEdit.classList.add('hidden');
                btnCustomize.classList.add('hidden');
                btnSave.classList.remove('hidden');
                btnPoke.classList.add('hidden');
                
                inputBio.value = modalBio.innerText === "No lore available." ? "" : modalBio.innerText;
                inputAge.value = modalAge.innerText.replace("LVL: ", "");
                inputGender.value = modalGender.innerText.replace("CLASS: ", "");
                
                bannerOverlay.classList.remove('hidden');
                bannerOverlay.classList.add('flex');
                pfpOverlay.classList.remove('hidden');
                pfpOverlay.classList.add('flex');
            } else {
                readModeInfo.classList.remove('hidden');
                editForm.classList.add('hidden');
                if (currentProfileUid === currentUser.uid) {
                    btnEdit.classList.remove('hidden');
                    btnCustomize.classList.remove('hidden');
                }
                else btnPoke.classList.remove('hidden');

                btnSave.classList.add('hidden');
                
                bannerOverlay.classList.add('hidden');
                bannerOverlay.classList.remove('flex');
                pfpOverlay.classList.add('hidden');
                pfpOverlay.classList.remove('flex');
            }
        }

        btnClose.onclick = () => modal.classList.add('hidden');
        btnEdit.onclick = () => toggleEditMode(true);
        myProfileBtn.onclick = () => openProfile(currentUser.uid);
        
        uploadPfp.onchange = async (e) => {
            if(e.target.files[0]) {
                const base64 = await toBase64(e.target.files[0]);
                modalPfp.src = base64; 
            }
        };
        uploadBanner.onchange = async (e) => {
            if(e.target.files[0]) {
                 const base64 = await toBase64(e.target.files[0]);
                 modalBanner.src = base64; 
            }
        };

        btnSave.onclick = async () => {
            if (!currentProfileUid) return;
            btnSave.innerText = "SAVING...";
            
            const newData = {
                bio: inputBio.value,
                age: inputAge.value,
                gender: inputGender.value,
                displayName: currentUser.displayName
            };

            try {
                if (uploadPfp.files[0]) {
                    const file = uploadPfp.files[0];
                    if (file.size > 1024 * 1024) { 
                        addNotification("PFP TOO CHONKY (Max 1MB). Compress it.", "error");
                        btnSave.innerText = "SAVE_GAME";
                        return;
                    }
                    newData.pfpURL = await toBase64(file);
                }
                
                if (uploadBanner.files[0]) {
                     const file = uploadBanner.files[0];
                    if (file.size > 2 * 1024 * 1024) { 
                        addNotification("BANNER TOO THICC (Max 2MB). Compress it.", "error");
                        btnSave.innerText = "SAVE_GAME";
                        return;
                    }
                    newData.bannerURL = await toBase64(file);
                }

                await setDoc(doc(db, "users", currentUser.uid), newData, { merge: true });
                beep(600);
                addNotification("GAME SAVED", "success");
                btnSave.innerText = "SAVE_GAME";
                toggleEditMode(false); 
            } catch (e) {
                addNotification("SAVE FAILED: " + e.message, "error");
                btnSave.innerText = "RETRY";
            }
        };

        btnLike.onclick = async () => {
            if (currentProfileUid === currentUser.uid) {
                addNotification("NARCISSISM DETECTED", "error");
                return;
            }
            
            const ref = doc(db, "users", currentProfileUid);
            const isLiked = !btnLike.classList.contains('grayscale');
            
            let currentCount = parseInt(modalLikes.innerText) || 0;

            if (isLiked) {
                btnLike.classList.add('grayscale');
                currentCount = Math.max(0, currentCount - 1);
                modalLikes.innerText = `${currentCount} SOUL${currentCount!==1?'S':''}`;
                await updateDoc(ref, { likedBy: arrayRemove(currentUser.uid) });
            } else {
                btnLike.classList.remove('grayscale');
                currentCount++;
                modalLikes.innerText = `${currentCount} SOUL${currentCount!==1?'S':''}`;

                const snap = await getDoc(ref);
                if(!snap.exists()) {
                    await setDoc(ref, { likedBy: [currentUser.uid] }, { merge: true });
                } else {
                    await updateDoc(ref, { likedBy: arrayUnion(currentUser.uid) });
                }
                
                // NOTIFICATION: LIKE
                sendRemoteNotification(currentProfileUid, "like", "SOMEONE DESIRES YOUR SOUL üî•");

                const flame = document.createElement('div');
                flame.innerText = "üî•";
                flame.style.position = "fixed";
                flame.style.left = event.clientX + "px";
                flame.style.top = event.clientY + "px";
                flame.style.fontSize = "2rem";
                flame.style.pointerEvents = "none";
                document.body.appendChild(flame);
                anime({
                    targets: flame,
                    translateY: -100,
                    opacity: 0,
                    duration: 1000,
                    easing: 'easeOutExpo',
                    complete: () => flame.remove()
                });
                beep(800);
            }
            
            const updatedSnap = await getDoc(ref);
            const count = updatedSnap.data().likedBy ? updatedSnap.data().likedBy.length : 0;
            modalLikes.innerText = `${count} SOUL${count!==1?'S':''}`;
        };

        bannerOverlay.onclick = () => uploadBanner.click();
        pfpOverlay.onclick = () => uploadPfp.click();

        setInterval(() => {
            const bubbles = document.querySelectorAll('.message-bubble');
            if (bubbles.length > 0) {
                const target = bubbles[Math.floor(Math.random() * bubbles.length)];
                target.style.transform = `translate(${Math.random()*2-1}px, ${Math.random()*2-1}px)`;
                setTimeout(() => target.style.transform = 'none', 100);
            }
        }, 1000);

    </script>
</body>
</html>
